{"published": "2015-09-30T11:04:54Z", "media-type": "Blog", "title": "SAML and Active Directory Federation Services (ADFS) Integration Errors, Events, Possible causes and Fixes", "id": "f40cd8da-0ed8-4e43-b000-d85db882ce9a", "content": "While working on setting up SAML communication with ADFS server/services, you\u2019ll come across various errors on the browser, error events on backend ADFS server and also on the web server that is sending the SAML requests to the ADFS server.  This article is to have most common errors, events and their possible causes and fixes.\n\n \n\nSCENARIO#1:\n\nERROR On the Browser: \n\nADFS UKService \n\nAn error occurred  \n\nAn error occurred. Contact your administrator for more information.  \n\nError details\n\nActivity ID: 00000000-0000-0000-2400-0080020000f6  \nError time: Wed, 30 Sep 2015 09:59:49 GMT \n\n\nError Event on the ADFS Server:\n\nLog Name:      AD FS/Admin\nSource:        AD FS\nDate:          9/30/2015 9:59:49 AM\nEvent ID:      364\nTask Category: None\nLevel:         Error\nKeywords:      AD FS\nUser:          UKService\\adfs$\nComputer:      ADFSUKServer.UKService.LAN\nDescription:\nEncountered error during federation passive request.  \n\nAdditional Data  \n\nProtocol Name: \nSaml  \n\nRelying Party: \nhttps://HRSecure.mycorpsite.com/SAMLPOC \n\nException details: \nMicrosoft.IdentityServer.Web.InvalidScopeException: MSIS7007: The requested relying party trust \u2018https://HRSecure.mycorpsite.com/SAMLPOC\u2019 is unspecified or unsupported. If a relying party trust was specified, it is possible that you do not have permission to access the trust relying party. Contact your administrator for details.\n   at Microsoft.IdentityServer.Web.Protocols.Saml.SamlSignInContext.Validate()\n   at Microsoft.IdentityServer.Web.Protocols.Saml.SamlProtocolHandler.GetRequiredPipelineBehaviors(ProtocolContext pContext)\n   at Microsoft.IdentityServer.Web.PassiveProtocolListener.OnGetContext(WrappedHttpListenerContext context) \n\nCause:\n\nThis error occurs when you attempt to communicate with ADFS server with non-existing or incorrect Relying Party URL.  In this case,  the relying party https://HRSecure.mycorpsite.com/SAMLPOC is not existing or nor yet defined on the ADFS server.\n\nSolution:\n\nGo Ahead and create a new Relying Party with Relying Party Identifier as https://HRSecure.mycorpsite.com/SAMLPOC.  \n\n \n\nSCENARIO#2:\n\nERROR On the Browser:  \n\nADFS UKService  \n\nAn error occurred  \n\nAn error occurred. Contact your administrator for more information.  \n\nError details\n\nActivity ID: 00000000-0000-0000-8500-0080000000f1  \nRelying party: SAMLPOCRelyingParty \nError time: Wed, 30 Sep 2015 10:19:37 GMT \n\n\nError Events on the ADFS Server:\n\nLog Name:      AD FS/Admin\nSource:        AD FS\nDate:          9/30/2015 10:19:37 AM\nEvent ID:      261\nTask Category: None\nLevel:         Error\nKeywords:      AD FS\nUser:          UKService\\adfs$\nComputer:      ADFSUKServer.UKService.LAN\nDescription:\nThe request specified an Assertion Consumer Service URL \u2018https://HRSecure.mycorpsite.com/SAMLPOC/Consume.aspx\u2019 that is not  configured on the relying party \u2018https://HRSecure.mycorpsite.com/SAMLPOC\u2019. \nAssertion Consumer Service URL: https://HRSecure.mycorpsite.com/SAMLPOC/Consume.aspx\nRelying party: https://HRSecure.mycorpsite.com/SAMLPOC \n\nThis request failed.  \n\nUser Action \nUse the AD FS Management snap-in to configure an Assertion Consumer Service with the specified URL for this relying party.  \n\nLog Name:      AD FS/Admin\nSource:        AD FS\nDate:          9/30/2015 10:19:37 AM\nEvent ID:      364\nTask Category: None\nLevel:         Error\nKeywords:      AD FS\nUser:          UKService\\adfs$\nComputer:      ADFSUKServer.UKService.LAN\nDescription:\nEncountered error during federation passive request.  \n\nAdditional Data  \n\nProtocol Name: \nSaml  \n\nRelying Party: \nhttps://HRSecure.mycorpsite.com/SAMLPOC \n\nException details: \nMicrosoft.IdentityServer.Service.Policy.PolicyServer.Engine.AssertionConsumerServiceUrlDoesNotMatchPolicyException: MSIS3200: No AssertionConsumerService is configured on the relying party trust \u2018https://HRSecure.mycorpsite.com/SAMLPOC\u2019 that is a prefix match of the AssertionConsumerService URL \u2018https://HRSecure.mycorpsite.com/SAMLPOC/Consume.aspx\u2019 specified by the request.\n   at Microsoft.IdentityServer.Service.SamlProtocol.EndpointResolver.LookupAssertionConsumerServiceByUrl(Collection`1 assertionConsumerServices, Uri requestedAssertionConsumerServiceUrl, String scopeIdentity)\n   at Microsoft.IdentityServer.Service.SamlProtocol.EndpointResolver.FindSamlResponseEndpointForAuthenticationRequest(Boolean artifactEnabled, AuthenticationRequest request, ScopeDescription scopeDescription)\n   at Microsoft.IdentityServer.Web.Protocols.Saml.SamlProtocolManager.GetResponseEndpointFromRequest(SamlRequest request, Boolean isUrlTranslationNeeded, ScopeDescription scope)\n   at Microsoft.IdentityServer.Web.Protocols.Saml.SamlProtocolManager.Issue(HttpSamlRequestMessage httpSamlRequestMessage, SecurityTokenElement onBehalfOf, String sessionState, String relayState, String& newSamlSession, String& samlpAuthenticationProvider, Boolean isUrlTranslationNeeded, WrappedHttpListenerContext context, Boolean isKmsiRequested)\n   at Microsoft.IdentityServer.Web.Protocols.Saml.SamlProtocolHandler.RequestBearerToken(WrappedHttpListenerContext context, HttpSamlRequestMessage httpSamlRequest, SecurityTokenElement onBehalfOf, String relyingPartyIdentifier, Boolean isKmsiRequested, Boolean isApplicationProxyTokenRequired, String& samlpSessionState, String& samlpAuthenticationProvider)\n   at Microsoft.IdentityServer.Web.Protocols.Saml.SamlProtocolHandler.BuildSignInResponseCoreWithSerializedToken(HttpSamlRequestMessage httpSamlRequest, WrappedHttpListenerContext context, String relyingPartyIdentifier, SecurityTokenElement signOnTokenElement, Boolean isKmsiRequested, Boolean isApplicationProxyTokenRequired)\n   at Microsoft.IdentityServer.Web.Protocols.Saml.SamlProtocolHandler.BuildSignInResponseCoreWithSecurityToken(SamlSignInContext context, SecurityToken securityToken, SecurityToken deviceSecurityToken)\n   at Microsoft.IdentityServer.Web.Protocols.Saml.SamlProtocolHandler.Process(ProtocolContext context)\n   at Microsoft.IdentityServer.Web.PassiveProtocolListener.ProcessProtocolRequest(ProtocolContext protocolContext, PassiveProtocolHandler protocolHandler)\n   at Microsoft.IdentityServer.Web.PassiveProtocolListener.OnGetContext(WrappedHttpListenerContext context)  \n\nCause:\n\nThis error and event logs indicate that the URL https://HRSecure.mycorpsite.com/SAMLPOC/Consume.aspx used as Assertion Consume URL doesn\u2019t match with that of the value configured as Assertion Consume URL for the chosen Relying Party on the ADFS server.\n\nSolution:\n\nGo Ahead and create or update the Assertion Consume URL as https://HRSecure.mycorpsite.com/SAMLPOC/Consume.aspx for your Relying Party (in above case its https://HRSecure.mycorpsite.com/SAMLPOC\u2019) on the ADFS server.                            \n\n\n\n  ( function() \n    if (window.CHITIKA === undefined) \n      window.CHITIKA =  'units' : [] ;\n    ;\n    var unit = \n      'publisher'       : 'gunnalag',\n      'width'           : 468,\n      'height'          : 120,\n      'sid'             : \"wordpress-plugin below\",\n      'color_site_link' : '0000CC',\n      'color_title'     : '0000CC',\n      'color_text'      : '000000',\n      'color_bg'        : 'ffffff',\n      'font_title'      : 'Verdana',\n      'font_text'       : 'Verdana',\n      'impsrc'          : 'wordpress',\n      'calltype'        : 'async[2]'\n    ;\n    var placement_id = window.CHITIKA.units.length;\n    window.CHITIKA.units.push(unit);\n    var x = \"\";\n    document.write(x);\n());\n\n//cdn.chitika.net/getads.js", "source": "Govardhan Gunnala"}